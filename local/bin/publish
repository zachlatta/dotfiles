#!/bin/bash

run() {
  echo
  echo "  \$ $@"
  echo

  "$@"
}

if [ "$*" == "" ]; then
  cat << EOF
publish is a small CLI utility to publish existing markdown files to Wordpress.

Requires Markpress to be set up and working.

Usage:

  $ publish [file.md]
EOF

  exit 1
fi

FILE="$1"
TITLE="${FILE%.*}"

# date file was first added to current folder
#
# sed removes the timezone section because wordpress doesn't support it
DATE=$(git log --diff-filter=A --follow --format=%ai -1 -- "$FILE" | sed 's/ -[0-9]\+$//')

# generate a tempfile name for the current directory
TMP="$(mktemp -u -p .)"

run markpress -n "$TMP"

# todo echo
cat "$FILE" >> "$TMP"

run sed -i "s/^title: \$/title: $TITLE\ndate: $DATE/" "$TMP"

run mv "$TMP" "$FILE"

run markpress -u "$FILE"

POST_ID="$(cat "$FILE" | grep uuid | sed 's/uuid: //')"

run "$BROWSER" "https://wordpress.com/block-editor/post/zachinto2020.wordpress.com/$POST_ID" 2> /dev/null
